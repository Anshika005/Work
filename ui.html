<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Import Tool</title>
  <style>
    /* --- NEW FONT AND COLOR SYSTEM --- */
    @font-face {
      font-family: "HankenGrotesk";
      src: url("https://cdn.jsdelivr.net/npm/@fontsource/hanken-grotesk@5.2.6/files/hanken-grotesk-latin-400-normal.woff2") format("woff2"),
      url("https://cdn.jsdelivr.net/npm/@fontsource/hanken-grotesk@5.2.6/files/hanken-grotesk-latin-400-normal.woff") format("woff");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    *,
    *::before,
    *::after {
       font-family: "HankenGrotesk", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
    }
     :root {
      --bg: #181818;
       --panel: #242424;
       --panel-2: #282828;
       --muted: #9ea6ab;
       --muted-2: #7c8387;
       --accent: #2b66ee;
       --white: #ffffff;
       --card-border: rgba(255, 255, 255, 0.04);
       --radius: 14px;
       --pad: 14px;
       --fs-sm: 12px;
       --fs-xs: 11px;
       --fc1: #282828;
       --fc2: #2C2C2C;
       --fc3: #383838;
       --fc4: #444444;
       --fc5: #818283;
       --fc6: #C5C5C5;
       --fc7: #FFFFFF;
       --fc8: #265BD1;
    }
    /* ================================================= */
    /* == Root & Base Styles == */
    /* ================================================= */
    :root {
      --bg-darkest: var(--bg);
      --bg-dark: var(--panel);
      --bg-medium: var(--panel-2);
      --bg-light: var(--fc4);
      --border-color: var(--card-border);
      --text-light: var(--white);
      --text-dim: var(--muted);
      --blue-primary: var(--accent);
      --blue-hover: var(--accent);
      --font-get-hover: var(--fc4);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background-color: var(--bg);
      color: var(--white);
      font-size: var(--fs-sm);
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    #root {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ================================================= */
    /* == Main App Shell (1033x240) == */
    /* ================================================= */
    .app-container {
      width: 1033px;
      height: 200px;
      background-color: var(--panel);
      border-radius: var(--radius);
      border: 1px solid var(----card-border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    /* --- 1. Header (Restored & Updated) --- */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: var(--pad);
      flex-shrink: 0;
      border-bottom: 1px solid var(--card-border);
      background-color: var(--panel-2);
    }
    .header-left { display: flex; align-items: center; gap: 8px; }
    .header-logo-img { /* For the new header icon */
      width: 16px;
      height: 16px;
    }
    .header-title { 
      font-weight: 500; 
      font-size: 14px; 
      color: var(--white);
    }
    .close-button { 
      cursor: pointer; 
      opacity: 0.7; 
      font-size: 20px; 
      padding: 4px; 
      color: var(--muted);
      line-height: 1;
    }
    .close-button:hover {
      opacity: 1;
      color: var(--white);
    }
    
    /* --- 2. Main Content (Sidebar + Main Area) --- */
    .main-content {
      display: flex;
      flex-grow: 1;
      min-height: 0;
    }

    /* --- 3. Sidebar (Dynamic) --- */
    .sidebar {
      width: 260px;
      flex-shrink: 0;
      padding: var(--pad);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border-right: 1px solid var(--border-color);
    }
    .sidebar-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .nav-arrow {
      font-size: 16px;
      color: var(--white);
      cursor: pointer;
      padding: 4px;
    }
    .nav-title { font-weight: 500; font-size: 14px; color: var(--white); }
    .info-icon-img { /* Renamed from .info-icon */
      width: 16px;
      height: 16px;
      margin-left: auto; /* Push to the right */
      cursor: pointer;
      opacity: 0.7;
      vertical-align: middle;
    }
    .info-icon-img:hover {
      opacity: 1;
    }
    
    /* --- Sidebar content for Uploading/Preview --- */
    .sidebar-file-info {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
    }
    .sidebar-file-info img { width: 32px; height: 32px; }
    .sidebar-file-info-text { font-size: 12px; flex-grow: 1; }
    .sidebar-file-info-text .filename {
      color: var(--text-light);
      display: flex;
      justify-content: space-between;
    }
    .sidebar-file-info-text .filesize { color: var(--text-dim); }
    .file-info-cancel {
      font-size: 12px;
      color: var(--blue-primary);
      cursor: pointer;
      font-weight: 500;
    }
    .progress-bar-wrapper {
      width: 100%;
      height: 4px;
      background-color: var(--bg-darkest);
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
    }
    .progress-bar-inner {
      height: 100%;
      width: 0%;
      background-color: var(--blue-primary);
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    @keyframes progress-indeterminate {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .progress-bar-inner.processing {
      width: 100%;
      background-image: linear-gradient(90deg, var(--blue-primary) 0%, var(--blue-hover) 50%, var(--blue-primary) 100%);
      animation: progress-indeterminate 1.5s infinite linear;
    }

    .sidebar-footer {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .sidebar-footer-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    .credit-balance {
      font-size: 12px;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .credit-icon-img, .info-icon-img { 
      width: 16px;
      height:16px;
      vertical-align: middle;
    }

    /* --- 4. Main Area (Dynamic) --- */
    .main-area {
      flex-grow: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    /* --- 5. Footer (Dynamic) --- */
    .app-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      padding: 12px 16px;
      border-top: 1px solid var(--border-color);
    }
    .footer-left, .footer-right { display: flex; align-items: center; gap: 8px; }
    .footer-center {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      color: var(--text-dim);
    }

    /* --- Buttons (Shared) --- */
    button {
      font-family: inherit;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: 500;
    }
    .button-secondary { background-color: var(--bg-medium); color: white; }
    .button-secondary:hover { background-color: var(--bg-light); }
    .button-primary { background-color: var(--blue-primary); color: white; }
    .button-primary:hover { background-color: var(--blue-hover); }

    /* ================================================= */
    /* == View 1: Importer Grid Styles == */
    /* ================================================= */
    .importer-tabs {
      display: inline-flex; /* Fit to content */
      gap: 4px;
      background-color: var(--panel-2);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 4px;
    }
    .importer-tab-button {
      font-family: inherit;
      font-weight: 500;
      font-size: var(--fs-sm);
      border: 1px solid transparent; /* For active state */
      border-radius: 6px; /* Inner radius */
      padding: 6px 12px;
      cursor: pointer;
      /* Inactive state */
      background-color: transparent;
      color: var(--muted);
      transition: all 0.2s;
    }
    .importer-tab-button:hover {
      color: var(--white);
      background-color: var(--fc4);
    }
    .importer-tab-button.active {
      /* Active state (like "All Importers" button) */
      background-color: var(--bg);
      color: var(--white);
      border-color: #E5A800;
    }
    .importer-grid {
      display: flex;
      gap: 16px;
      padding-top: 16px;
    }
    .importer-icon {
      width: 80px; height: 80px;
      background-color: var(--panel-2);
      border-radius: var(--radius);
      border: 1px solid var(--card-border);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      font-size: var(--fs-sm);
      color: var(--white);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .importer-icon:hover { background-color:var(--muted-2); }
    .importer-icon img { width: 40px; /* Larger icon */
      height: 40px; 
      margin-bottom: 8px; 
      object-fit: contain; }
    .favorite-icon-img {
      position: absolute;
      top: 10px; right: 10px;
      width: 14px;
      height: 14px;
      color: white;
      opacity: 0.7;
    }
    .favorite-icon-img:hover {
      opacity: 1;
    }
    .favorite-icon-img[src=""] {
      display: none;
    }

    /* ================================================= */
    /* == View 2: Upload Styles == */
    /* ================================================= */
    .upload-view {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      background-color: var(--bg-darkest);
      border: 1px dashed var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .upload-view:hover { border-color: var(--blue-primary); border-style: solid; }
    .upload-view img { width: 32px; height: 32px; }
    .upload-view p { margin: 8px 0 4px 0; }
    .upload-view .small { font-size: 12px; color: var(--text-dim); margin-top: 0; }

    /* ================================================= */
    /* == View 3: Preview Styles == */
    /* ================================================= */
    .preview-content {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 24px;
      flex-grow: 1;
      min-height: 0;
    }
    .preview-column {
      display: flex;
      flex-direction: column;
    }
    .preview-column h3 {
      font-size: 12px;
      font-weight: 500;
      margin: 0 0 8px 0;
      color: var(--text-light);
    }
    .preview-column .preview-box {
      width: 100%;
      background-color: var(--bg-darkest);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      flex-grow: 1;
      min-height: 100px;
    }
    .preview-box img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .preview-box-processing {
      font-size: 12px;
      color: var(--text-dim);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .enlarge-icon {
      position: absolute;
      bottom: 8px; right: 8px;
      cursor: pointer; opacity: 0.7;
    }
    .enlarge-icon:hover { opacity: 1; }

    .font-column { display: flex; flex-direction: column; min-height: 0; }
    .font-column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .font-column-header h3 { margin: 0; font-size: 12px; font-weight: 500;}
    .vectorize-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text-light);
    }
    .vectorize-toggle label { cursor: pointer; }
    .vectorize-toggle input { accent-color: var(--blue-primary); }

    .font-list-box {
      background-color: var(--bg-darkest);
      border-radius: 8px;
      padding: 8px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      min-height: 100px;
    }
    .font-list-box-processing {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-dim);
      height: 100%;
    }
    .font-list-box .info-text {
      font-size: 12px;
      color: var(--text-dim);
      padding: 4px 8px 12px 8px;
      display: flex;
      gap: 8px;
    }
    .font-list-box .info-icon-small { color: var(--blue-primary); }
    .font-list { list-style: none; padding: 0; margin: 0; }
    .font-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 8px;
      border-bottom: 1px solid var(--bg-dark);
    }
    .font-row:last-child { border-bottom: none; }
    .font-name { font-size: 13px; }
    .font-status-available {
      font-size: 12px;
      color: var(--text-dim);
      border: 1px solid var(--border-color);
      padding: 4px 8px;
      border-radius: 4px;
    }
    .font-get-button {
      font-size: 12px;
      background-color: var(--bg-medium);
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    .font-get-button:hover { background-color: var(--font-get-hover); }

    /* --- Spinner --- */
    .spinner {
      width: 16px; height: 16px;
      border: 2px solid var(--border-color);
      border-top-color: var(--text-light);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ================================================= */
    /* == Modals (Warning, Info, Enlarge) == */
    /* ================================================= */
    .modal-overlay {
      position: fixed; inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 10;
    }
    .modal-content {
      background-color: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .warning-modal .modal-content {
      width: 320px; padding: 24px;
      display: flex; flex-direction: column; gap: 16px;
    }
    .warning-modal h4 { margin: 0; }
    .warning-modal p { margin: 0; font-size: 13px; color: #ccc; line-height: 1.5; }
    .warning-modal .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px; }

    .info-modal .modal-content { width: 535px; }
    .info-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
    }
    .info-modal-header h4 { margin: 0; font-size: 14px; font-weight: 500; }
    .info-modal-body {
      padding: 24px;
      display: flex;
      gap: 20px;
      align-items: center;
      background-color: var(--bg-darkest);
      border-top: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
    }
    .info-modal-body img {
      width: 150px;
      height: 124px;
      object-fit: contain;
      flex-shrink: 0;
      background-color: #F0F0F0;
      border-radius: 6px;
    }
    .info-modal-text h5 { margin: 0 0 8px 0; font-size: 15px; }
    .info-modal-text p, .info-modal-text li { font-size: 13px; color: #ccc; line-height: 1.5; }
    .info-modal-text ul { padding-left: 20px; margin: 8px 0 0 0; }
    .info-modal-footer {
      display: flex;
      justify-content: center;
      padding: 16px;
      gap: 8px;
    }
    .dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background-color: var(--bg-medium);
      cursor: pointer;
    }
    .dot.active { background-color: var(--text-light); }

    .enlarge-modal-content {
      width: 90vw;
      height: 90vh;
      background-color: var(--bg-darkest);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .enlarge-modal-content img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    'use strict';
    const { useState, Fragment, useEffect } = React;
    
    function postMessage(type, payload) {
      console.log('Sending message:', type, payload);
      parent.postMessage({ pluginMessage: { type, payload } }, '*');
    }

    // --- ADD YOUR ICON URLS HERE ---
    const FAVORITE_ICON_URL = "https://res.cloudinary.com/dvufcaqt1/image/upload/v1762860783/Vector_1_okcrww.svg";
    const UNFAVORITE_ICON_URL = ""; // Set to "" for "blank" as requested

    // Add your header icon URL here
    const HEADER_ICON_URL = "";
    // This is the broken image URL from your screenshot
    const PREVIEW_IMAGE_URL = "https://i.imgur.com/v81mU6y.png";

    const infoModalPages = [
      {
        title: "File Importer",
        img: "https://i.imgur.com/g0RkI56.png",
        content: (
          <Fragment>
            <p>Import Tool allows you to bring files from various design and data formats directly into Figma...</p>
            <p style={{marginTop: '10px'}}>It automatically parses content, previews layers, detects fonts...</p>
          </Fragment>
        )
      },
      { title: "Import EPS", img: "https://i.imgur.com/L4Gj1qM.png", content: <p>EPS Importer...</p> },
      { title: "Up coming updates...", img: "https://i.imgur.com/tOa7U3f.png", content: <p>PSD, AI, CSV...</p> }
    ];

    const importers = [
      { id: 'eps', name: 'EPS', icon: "https://res.cloudinary.com/dvufcaqt1/image/upload/v1763482243/Group_1171277747_orxtl0.svg" },
      { id: 'psd', name: 'PSD', icon: "https://res.cloudinary.com/dvufcaqt1/image/upload/v1763482292/Group_1171277745_5_kijc8s.svg" },
      { id: 'ai', name: 'AI', icon: "https://res.cloudinary.com/dvufcaqt1/image/upload/v1763482331/Group_1171277745_6_w8kqsp.svg" },
      { id: 'json', name: 'JSON', icon:"https://res.cloudinary.com/dvufcaqt1/image/upload/v1763482368/Group_1171277745_7_mtsd5o.svg" },
      { id: 'csv', name: 'CSV', icon:"https://res.cloudinary.com/dvufcaqt1/image/upload/v1763482402/Group_2_jgvfes.svg" },
      { id: 'fbx', name: 'FBX', icon: "https://res.cloudinary.com/dvufcaqt1/image/upload/v1763482429/Group_1171277745_8_o19xzl.svg" },
      { id: 'ppt', name: 'PPT', icon: "https://res.cloudinary.com/dvufcaqt1/image/upload/v1763482456/Group_1171277745_9_zqhlae.svg" },
    ];
    
    // --- Main App Component ---
    function App() {
      const [currentView, setCurrentView] = useState('select_importer');
      const [uploadState, setUploadState] = useState('idle'); 
      const [showWarningModal, setShowWarningModal] = useState(false);
      const [isInfoModalOpen, setIsInfoModalOpen] = useState(false);
      const [isEnlargedModalOpen, setIsEnlargedModalOpen] = useState(false);
      const [isVectorized, setIsVectorized] = useState(true);
      const [creditBalance, setCreditBalance] = useState(2);
      
      // --- NEW STATE FOR FAVORITES ---
      const [activeTab, setActiveTab] = useState('all');
      const [favorites, setFavorites] = useState({ eps: true }); // Default 'eps' to favorited
      
      const dummyFontData = [
        { name: 'Hanken Grotesk (Regular)', isAvailable: true },
        { name: 'Roboto (Regular)', isAvailable: false }
      ];
      
      const setView = (viewName) => {
        setUploadState('idle'); 
        if (viewName === 'select_importer') {
          setCreditBalance(2);
        }
        setCurrentView(viewName);
      };
      
      const handleFileSelect = () => {
        setUploadState('uploading');
        setCurrentView('preview');
        setCreditBalance(200);

        setTimeout(() => {
          setUploadState('processing');
        }, 1500); 

        setTimeout(() => {
          setUploadState('done');
        }, 3000);
      };
    
      const handleImportClick = () => {
        const hasMissingFonts = dummyFontData.some(font => !font.isAvailable);
        if (!isVectorized && hasMissingFonts) {
          setShowWarningModal(true);
        } else {
          performImport();
        }
      };
      
      const performImport = () => {
        setShowWarningModal(false); 
        alert('Importing now! (Check the console)');
        postMessage('import-file', { vectorized: isVectorized, fonts: dummyFontData });
      };

      // --- NEW FUNCTION for toggling favorites ---
      const toggleFavorite = (id) => {
        setFavorites(prevFavorites => ({
          ...prevFavorites,
          [id]: !prevFavorites[id]
        }));
        postMessage('toggle-favorite', { id: id, isFavorite: !favorites[id] });
      };

      // --- Main Area Renderer ---
      const renderMainArea = () => {
        switch (currentView) {
          case 'select_importer':
            return <View_ImporterGrid 
                      setView={setView}
                      activeTab={activeTab}
                      setActiveTab={setActiveTab}
                      favorites={favorites}
                      toggleFavorite={toggleFavorite}
                    />;
          case 'upload':
            return <View_Upload onFileSelect={handleFileSelect} />;
          case 'preview':
            return <View_Preview 
                      fontData={dummyFontData}
                      isVectorized={isVectorized}
                      onVectorizeChange={setIsVectorized}
                      uploadState={uploadState}
                      onEnlarge={() => setIsEnlargedModalOpen(true)}
                    />;
          default:
            return <p>Error</p>;
        }
      };
      
      // --- Footer Renderer ---
      const renderFooter = () => {
        switch (currentView) {
          case 'select_importer':
          case 'upload':
            return <div className="footer-center">^</div>;
          case 'preview':
            return (
              <Fragment>
                <div className="footer-center">^</div>
                <div className="footer-right">
                  <button className="button-secondary" onClick={() => setView('upload')}>Use another</button>
                  <button 
                    className="button-primary" 
                    onClick={handleImportClick}
                    disabled={uploadState !== 'done'}
                  >
                    Import now
                  </button>
                </div>
              </Fragment>
            );
          default:
            return null;
        }
      };

      // --- Sidebar Content Renderer ---
      const renderSidebarContent = () => {
        const nav = (
          <div className="sidebar-nav">
            <span className="nav-arrow" onClick={() => {
              if (currentView === 'upload') setView('select_importer');
              if (currentView === 'preview') setView('upload');
            }}>&lt;</span>
            <span className="nav-title">File Importer</span>
            <img src="https://res.cloudinary.com/dvufcaqt1/image/upload/v1760420877/info_detkgl.svg" alt="Info" className="info-icon-img" onClick={() => setIsInfoModalOpen(true)} style={{cursor: 'pointer'}} />
          </div>
        );

        const credits = (
           <div className="credit-balance">
              <simg src="https://res.cloudinary.com/dvufcaqt1/image/upload/v1762805325/Vector_bgol9a.svg" alt="Credits" className="credit-icon-img" />
              <span>Your current credit balance is {creditBalance} credits</span>
            </div>
        );

        switch(currentView) {
          case 'preview':
            return (
              <Fragment>
                <div>
                  {nav}
                  <SidebarFileInfo uploadState={uploadState} onCancel={() => setView('upload')} />
                </div>
                <div className="sidebar-footer">
                  {credits}
                  {uploadState === 'done' && (
                    <div className="sidebar-footer-buttons">
                      {/* FIX: Typo corrected */}
                      <button className="button-secondary" onClick={() => setView('select_importer')}>Go Back</button>
                      <button className="button-primary">Get Credits</button>
                    </div>
                  )}
                </div>
              </Fragment>
            );
          
          case 'upload':
             return (
              <Fragment>
                {nav}
                <div className="sidebar-footer">
                  {credits}
                </div>
              </Fragment>
            );
            
          case 'select_importer':
          default:
            return (
              <Fragment>
                {nav}
                <div className="sidebar-footer">
                  {credits}
                </div>
              </Fragment>
            );
        }
      };
    
      // --- Final Render ---
      return (
        <Fragment>
          <div className="app-container">
            <main className="main-content">
              <aside className="sidebar">
                {renderSidebarContent()}
              </aside>

              <section className="main-area">
                {renderMainArea()}
              </section>
            </main>

            <footer className="app-footer">
              {renderFooter()}
            </footer>
          </div>

          {isInfoModalOpen && <InfoModal onClose={() => setIsInfoModalOpen(false)} />}
          {showWarningModal && (
            <WarningModal 
              onCancel={() => setShowWarningModal(false)}
              onConfirm={performImport}
            />
          )}
          {isEnlargedModalOpen && (
            <EnlargeModal 
              imgSrc={PREVIEW_IMAGE_URL}
              onClose={() => setIsEnlargedModalOpen(false)} 
            />
          )}
        </Fragment>
      );
    }
    
    // --- View 1: Importer Grid ---
    function View_ImporterGrid({ setView, activeTab, setActiveTab, favorites, toggleFavorite }) {
      
      const displayedImporters = activeTab === 'all' 
        ? importers 
        : importers.filter(imp => favorites[imp.id]);

      return (
        <Fragment>
          <div className="importer-tabs">
            <button 
              className={`importer-tab-button ${activeTab === 'all' ? 'active' : ''}`}
              onClick={() => setActiveTab('all')}
            >
              All Importers
            </button>
            <button 
              className={`importer-tab-button ${activeTab === 'favorites' ? 'active' : ''}`}
              onClick={() => setActiveTab('favorites')}
            >
              Favorites
            </button>
          </div>
          <div className="importer-grid">
            {displayedImporters.map(importer => (
              <div 
                className="importer-icon" 
                key={importer.id}
                onClick={() => {
                  if (importer.id === 'eps') setView('upload');
                  else alert(`${importer.name} importer is coming soon!`);
                }}
              >
                <span 
                  className={`heart-icon ${favorites[importer.id] ? 'filled' : ''}`}
                  onClick={(e) => {
                    e.stopPropagation();
                    toggleFavorite(importer.id);
                  }}
                >
                  {favorites[importer.id] ? '♥' : '♡'}
                </span>
                <img src={importer.icon} alt={importer.name} />
                {importer.name}
              </div>
            ))}
          </div>
        </Fragment>
      );
    }
    
    // --- View 2: Upload Screen ---
    function View_Upload({ onFileSelect }) {
      return (
        <div className="upload-view" onClick={onFileSelect}>
          <img src="https://v5.services.img.s3.amazonaws.com/icon/icon_EPS_Mesa+de+trabajo+1.svg" alt="EPS" />
          <p>Click and Select file here</p>
          <p className="small">Max file size: 50MB</p>
        </div>
      );
    }
    
    // --- View 3: Preview Screen ---
    function View_Preview({ fontData, isVectorized, onVectorizeChange, uploadState, onEnlarge }) {
      
      const renderPreviewBox = () => {
        if (uploadState === 'done') {
          // *** THE FIX IS HERE ***
          // We render the <img> tag, which will correctly show the broken image 
          // placeholder from your screenshot.
          return (
            <Fragment>
              <img src={PREVIEW_IMAGE_URL} alt="Preview" />
              <span className="enlarge-icon" onClick={onEnlarge}>⛶</span>
            </Fragment>
          );
        }
        // Show processing spinner
        return (
          <div className="preview-box-processing">
            <div className="spinner"></div>
            <span>Import in process...</span>
          </div>
        );
      };

      const renderFontList = () => {
        if (uploadState === 'done') {
          // Show the final font list
          return (
            <Fragment>
              <p className="info-text">
                <span className="info-icon-small">ⓘ</span>
                <span>Install required fonts before importing, else they'll default to Inter. For non-editable text, vectorize fonts.</span>
              </p>
              <ul className="font-list">
                {fontData.map((font, index) => (
                  <FontRow 
                    key={`${font.name}-${index}`}
                    fontName={font.name} 
                    isAvailable={font.isAvailable} 
                    onGetFontClick={() => postMessage('get-font', { fontName: font.name })}
                  />
                ))}
              </ul>
            </Fragment>
          );
        }
        // Show processing spinner
        return (
          <div className="font-list-box-processing">
            <div className="spinner"></div>
            <span>Import in process...</span>
          </div>
        );
      };

      return (
        <div className="preview-content">
          <div className="preview-column">
            <h3>Preview</h3>
            <div className="preview-box">
              {renderPreviewBox()}
            </div>
          </div>
          
          <div className="font-column">
            <div className="font-column-header">
              <h3>Font in use</h3>
              <div className="vectorize-toggle">
                <label htmlFor="vectorize">Vectorize</label>
                <input 
                  id="vectorize" type="checkbox" 
                  checked={isVectorized}
                  onChange={(e) => onVectorizeChange(e.target.checked)} 
                  disabled={uploadState !== 'done'}
                />
              </div>
            </div>
            <div className="font-list-box">
              {renderFontList()}
            </div>
          </div>
        </div>
      );
    }

    // --- Sidebar File Info Component (with progress) ---
    function SidebarFileInfo({ uploadState, onCancel }) {
      const [progress, setProgress] = useState(0);

      useEffect(() => {
        if (uploadState === 'uploading') {
          setProgress(0);
          setTimeout(() => setProgress(60), 500);
          setTimeout(() => setProgress(100), 1200);
        }
        // *** THIS IS THE FIX FOR THE INFINITE LOOP ***
        // Only set progress when state *changes* to 'processing'
        if (uploadState === 'processing') {
           setProgress(100); 
        }
      }, [uploadState]);

      let statusText = "Uploading...";
      if (uploadState === 'processing') {
        statusText = "Processing...";
        // No setProgress(100) here!
      }
      if (uploadState === 'done') statusText = "Uploaded";
      
      const showProgressBar = uploadState === 'uploading' || uploadState === 'processing';

      return (
        <div className="sidebar-file-info">
          <img src="https://v5.services.img.s3.amazonaws.com/icon/icon_EPS_Mesa+de+trabajo+1.svg" alt="EPS" />
          <div className="sidebar-file-info-text">
            <div className="filename">
              <span>ADSVX353.eps</span>
              {uploadState === 'uploading' && <span className="file-info-cancel" onClick={onCancel}>Cancel</span>}
            </div>
            <div className="filesize">459 KB · {statusText}</div>
            {showProgressBar && (
              <div className="progress-bar-wrapper">
                <div 
                  className={`progress-bar-inner ${uploadState === 'processing' ? 'processing' : ''}`}
                  style={{ width: `${progress}%` }}
                ></div>
              </div>
            )}
          </div>
        </div>
      );
    }
    
    // --- Sub-component: Font Row ---
    function FontRow({ fontName, isAvailable, onGetFontClick }) {
      return (
        <li className="font-row">
          <span className="font-name">{fontName}</span>
          {isAvailable ? (
            <span className="font-status-available">Font is available</span>
          ) : (
            <button className="font-get-button" onClick={onGetFontClick}>Get from Google fonts</button>
          )}
        </li>
      );
    }
    
    // --- Sub-component: Warning Modal ---
    function WarningModal({ onCancel, onConfirm }) {
      return (
        <div className="modal-overlay warning-modal">
          <div className="modal-content">
            <h4>Attention!</h4>
            <p>Fonts are not installed... Would you like to continue?</p>
            <div className="modal-actions">
              <button className="button-secondary" onClick={onCancel}>Cancel</button>
              <button className="button-primary" onClick={onConfirm}>Import</button>
            </div>
          </div>
        </div>
      );
    }

    // --- Sub-component: Info Modal ---
    function InfoModal({ onClose }) {
      const [page, setPage] = useState(0);
      const currentPage = infoModalPages[page];

      return (
        <div className="modal-overlay info-modal">
          <div className="modal-content">
            <header className="info-modal-header">
              <h4>{currentPage.title}</h4>
              <span className="close-button" onClick={onClose}>×</span>
            </header>
            <main className="info-modal-body">
              <img src={currentPage.img} alt={currentPage.title} />
              <div className="info-modal-text">
                <h5>{currentPage.title}</h5>
                {currentPage.content}
              </div>
            </main>
            <footer className="info-modal-footer">
              {infoModalPages.map((_, index) => (
                <div 
                  key={index}
                  className={`dot ${index === page ? 'active' : ''}`}
                  onClick={() => setPage(index)}
                />
              ))}
            </footer>
          </div>
        </div>
      );
    }

    // --- Sub-component: Enlarge Modal ---
    function EnlargeModal({ imgSrc, onClose }) {
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content enlarge-modal-content" onClick={(e) => e.stopPropagation()}>
            {/* It will show the broken image here too, matching the preview */ }
            <img src={imgSrc} alt="Enlarged preview" />
          </div>
        </div>
      );
    }
    
    // --- This starts your React App ---
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>